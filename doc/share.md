# SkyPlayerï¼šç§»åŠ¨ç«¯ FFmpeg æ’­æ”¾å™¨æ·±åº¦å®è·µ

## é¡¹ç›®ä»‹ç»

### ä»€ä¹ˆæ˜¯ SkyPlayerï¼Ÿ

SkyPlayer æ˜¯ä¸€ä¸ª **ç§»åŠ¨ç«¯** éŸ³è§†é¢‘æ’­æ”¾å™¨ï¼ˆæš‚æ”¯æŒAndroidï¼‰ï¼ŒåŸºäº FFmpeg 8.0 å®˜æ–¹ ffplay æ·±åº¦æ”¹é€ ã€‚  
ğŸ”— **é¡¹ç›®åœ°å€**ï¼š[https://github.com/zhiwei-wu/SkyPlayer](https://github.com/zhiwei-wu/SkyPlayer)

### é¡¹ç›®ç‰¹ç‚¹
#### 1. åŸºäº ffplay æ ¸å¿ƒæ”¹é€ 
- **FFmpeg 8.0**ï¼šä½¿ç”¨ FFmpeg æœ€æ–°ç¨³å®šç‰ˆæœ¬ï¼Œè·å¾—æœ€æ–°çš„æ ¼å¼æ”¯æŒå’Œæ€§èƒ½ä¼˜åŒ–
- **ä¿ç•™ç»å…¸æ¶æ„**ï¼šå®Œæ•´ä¿ç•™ `ffplay.c` æ’­æ”¾å¼•æ“
- **ç»è¿‡éªŒè¯çš„ç¨³å®šæ€§**ï¼šffplay ä½œä¸º FFmpeg å®˜æ–¹æ’­æ”¾å™¨ç¤ºä¾‹ï¼Œç»è¿‡æ•°åå¹´å®æˆ˜éªŒè¯
- **å®Œæ•´çš„æ’­æ”¾æµç¨‹**ï¼šä»è§£å°è£…ã€è§£ç ã€éŸ³ç”»åŒæ­¥åˆ°æ¸²æŸ“çš„å…¨é“¾è·¯å®ç°

#### 2. é’ˆå¯¹ Android å¹³å°æ·±åº¦ä¼˜åŒ–
- **OpenGL ES 2.0 æ¸²æŸ“**ï¼š5 ç§ç‹¬ç«‹ä¼˜åŒ–çš„æ¸²æŸ“å™¨ï¼Œæ”¯æŒ YUV420P/422Pã€NV12/21ã€RGBA
- **OpenSL ES éŸ³é¢‘**ï¼šè¶…ä½å»¶è¿ŸéŸ³é¢‘è¾“å‡ºï¼ˆ< 20msï¼‰ï¼Œè¿œä¼˜äº AudioTrack
- **å®‰å…¨çš„ JNI è®¾è®¡**ï¼šçº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼ˆTLSï¼‰ã€è‡ªåŠ¨ attach/detachã€å¼±å¼•ç”¨é˜²æ³„æ¼ï¼Œé¿å…å¸¸è§çš„ JNI å†…å­˜æ³„æ¼å’Œå´©æºƒé—®é¢˜

#### 3. å·¥ç¨‹åŒ–è®¾è®¡
- **çº¿ç¨‹å®‰å…¨**ï¼šå®Œæ•´çš„å¤šçº¿ç¨‹å®‰å…¨è®¾è®¡å’Œå†…å­˜ç®¡ç†ï¼Œé¿å…å¹¶å‘é—®é¢˜
- **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œèµ„æºé‡Šæ”¾æœºåˆ¶ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
- **æ¶ˆæ¯é˜Ÿåˆ—**ï¼šå¼‚æ­¥äº‹ä»¶å¤„ç†ï¼Œè§£è€¦æ’­æ”¾æ§åˆ¶å’ŒçŠ¶æ€é€šçŸ¥
- **RAII æœºåˆ¶**ï¼šä½¿ç”¨ç°ä»£ C++ çš„ RAII æ¨¡å¼ç®¡ç†èµ„æºç”Ÿå‘½å‘¨æœŸ

#### 4. æ¸…æ™°çš„æ¶æ„è®¾è®¡
- **åˆ†å±‚æ¶æ„**ï¼šJavaã€JNIã€Nativeã€FFmpeg å››å±‚æ¸…æ™°åˆ†ç¦»
- **C/C++ æ··åˆç¼–ç¨‹**ï¼šä½¿ç”¨ç°ä»£ C++ å°è£… C è¯­è¨€çš„ ffplay.cï¼Œè§£å†³ Câ†’C++ å’Œ C++â†’C çš„åŒå‘è°ƒç”¨é—®é¢˜ï¼Œå®ç°è°ƒç”¨éš”ç¦»å’Œæ‰©å±•æ€§
- **JNI å®‰å…¨æ€§**ï¼šå®Œæ•´çš„çº¿ç¨‹å®‰å…¨æœºåˆ¶ï¼Œé¿å…å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„å´©æºƒå’Œå†…å­˜æ³„æ¼
- **æ˜“äºç†è§£**ï¼šæ¯ä¸ªæ¨¡å—èŒè´£æ˜ç¡®ï¼Œä»£ç æ³¨é‡Šå®Œæ•´
- **ä¾¿äºæ‰©å±•**ï¼šåŸºäºæ¥å£è®¾è®¡ï¼Œæ”¯æŒè‡ªå®šä¹‰æ¸²æŸ“å™¨å’ŒéŸ³é¢‘è¾“å‡º

#### 5. ä¼˜ç§€çš„å­¦ä¹ ä»·å€¼
- **å®Œæ•´çš„æŠ€æœ¯æ ˆ**ï¼šæ¶µç›– FFmpegã€JNIã€OpenGL ESã€OpenSL ES
- **å¯è¿è¡Œçš„ç¤ºä¾‹**ï¼šapp æ¨¡å—æä¾›å®Œæ•´çš„ Demo
- **æ•™å­¦çº§ä»£ç **ï¼šé€‚åˆå­¦ä¹ éŸ³è§†é¢‘å¼€å‘çš„å®Œæ•´å®ç°

ç›®å‰å·²æ”¯æŒæœ¬åœ°æ–‡ä»¶æ’­æ”¾ï¼Œiosç«¯ã€åœ¨çº¿æ’­æ”¾ã€ç›´æ’­ç­‰åŠŸèƒ½æŒç»­è¿­ä»£ä¸­ã€‚

## æŠ€æœ¯æ¶æ„

### æ•´ä½“æ¶æ„å›¾

SkyPlayer é‡‡ç”¨æ¸…æ™°çš„åˆ†å±‚æ¶æ„è®¾è®¡ï¼Œä»ä¸Šåˆ°ä¸‹åˆ†ä¸ºå››å±‚ï¼Œå¹¶é€šè¿‡ä¸‰å±‚è°ƒç”¨é“¾è·¯å®ç°è·¨è¯­è¨€é€šä¿¡ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Java/Kotlin Layer                            â”‚
â”‚                     (SkyMediaPlayer.kt)                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ â€¢ æ¥å£è®¾è®¡ï¼šå…¼å®¹ MediaPlayer API                               â”‚  â”‚
â”‚  â”‚ â€¢ äº‹ä»¶å¤„ç†ï¼šMediaEventHandler                                 â”‚  â”‚
â”‚  â”‚ â€¢ ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼šSurfaceã€ç›‘å¬å™¨ç­‰                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ â¬‡ Kotlin â†’ Native (JNI è°ƒç”¨)
                           â”‚ â€¢ _native_setup() / _setDataSource()
                           â”‚ â€¢ _prepareAsync() / _start() / _pause()
                           â”‚ â€¢ _seekTo() / _getCurrentPosition()
                           â”‚ â¬† Native â†’ Kotlin (äº‹ä»¶å›è°ƒ)
                           â”‚ â€¢ postEventFromNative()
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          JNI Layer                                  â”‚
â”‚                   (skymediaplayer_jni.cpp)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ â€¢ æ–¹æ³•æ³¨å†Œï¼šJNI_OnLoad                                         â”‚  â”‚
â”‚  â”‚ â€¢ çº¿ç¨‹å®‰å…¨ï¼špthread TLS ç®¡ç† JNIEnv                            â”‚  â”‚
â”‚  â”‚ â€¢ å¯¹è±¡ç®¡ç†ï¼šå¼±å…¨å±€å¼•ç”¨é˜²æ³„æ¼                                    â”‚  â”‚
â”‚  â”‚ â€¢ äº‹ä»¶å›è°ƒï¼špostEventToJava()                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ C++ å¯¹è±¡è°ƒç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Native Layer (C++)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              æ’­æ”¾å™¨æ ¸å¿ƒ (skymediaplayer.cpp)                   â”‚  â”‚
â”‚  â”‚  â€¢ å°è£… ffplay æ’­æ”¾å¼•æ“                                        â”‚  â”‚
â”‚  â”‚  â€¢ æ’­æ”¾æ§åˆ¶ï¼šstart/pause/seek                                  â”‚  â”‚
â”‚  â”‚  â€¢ çŠ¶æ€ç®¡ç†ï¼šprepared/playing/paused                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         è§†é¢‘æ¸²æŸ“å™¨ (SkyVideoOutHandler)                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ SkyEGL2Renderer (skyrenderer.cpp)                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ EGL åˆå§‹åŒ–å’Œé…ç½®                                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ OpenGL ES 2.0 ä¸Šä¸‹æ–‡ç®¡ç†                              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ 5 ç§åƒç´ æ ¼å¼æ¸²æŸ“å™¨ï¼š                                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    - YUV420P / YUV422P / NV12 / NV21 / RGBA            â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ Android å¹³å°å¯¹æ¥                                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ ANativeWindow (ä» Surface è·å–)                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ EGL Surface åˆ›å»ºå’Œç»‘å®š                                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ ç¡¬ä»¶åŠ é€Ÿæ¸²æŸ“åˆ°å±å¹•                                     â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         éŸ³é¢‘è¾“å‡º (SkyAudioOutHandler)                          â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ SkySLESAudioOut (skyaudio.cpp)                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ OpenSL ES å¼•æ“åˆ›å»ºå’Œåˆå§‹åŒ–                            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ è¾“å‡ºæ··éŸ³å™¨é…ç½®                                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ éŸ³é¢‘æ’­æ”¾å™¨åˆ›å»º                                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ ç¼“å†²åŒºé˜Ÿåˆ—ç®¡ç†                                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ ä½å»¶è¿Ÿæ’­æ”¾ (< 20ms)                                   â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ Android å¹³å°å¯¹æ¥                                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ OpenSL ES API                                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ Android éŸ³é¢‘æ¡†æ¶                                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ ç¡¬ä»¶éŸ³é¢‘è¾“å‡º                                          â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚      æ¶ˆæ¯é˜Ÿåˆ— (sky_msg_queue.cpp)                              â”‚  â”‚
â”‚  â”‚  â€¢ å¼‚æ­¥äº‹ä»¶å¤„ç†                                                â”‚  â”‚
â”‚  â”‚  â€¢ çº¿ç¨‹é—´é€šä¿¡                                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚      C/C++ æ¥å£æ¡¥æ¥ (skymediaplayer_interface.h)               â”‚  â”‚
â”‚  â”‚  â€¢ sky_display_image() - è§†é¢‘å¸§æ˜¾ç¤º                            â”‚  â”‚
â”‚  â”‚  â€¢ sky_open_audio() - éŸ³é¢‘è®¾å¤‡æ‰“å¼€                             â”‚  â”‚
â”‚  â”‚  â€¢ sky_pause_audio() - éŸ³é¢‘æš‚åœæ§åˆ¶                            â”‚  â”‚
â”‚  â”‚  â€¢ sky_post_message() - æ¶ˆæ¯ä¼ é€’                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ â¬‡ C++ â†’ C (ç›´æ¥è°ƒç”¨ ffplay.h æ¥å£)
                           â”‚ â€¢ stream_open() / stream_close()
                           â”‚ â€¢ toggle_pause() / stream_seek()
                           â”‚ â¬† C â†’ C++ (é€šè¿‡ skymediaplayer_interface.h)
                           â”‚ â€¢ sky_display_image() / sky_open_audio()
                           â”‚ â€¢ sky_post_message()
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       FFmpeg Layer (C)                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              ffplay æ ¸å¿ƒ (ffplay.c/h - 126KB)                  â”‚  â”‚
â”‚  â”‚  â€¢ å®Œæ•´çš„æ’­æ”¾å¼•æ“                                              â”‚  â”‚
â”‚  â”‚  â€¢ è§£å°è£…ã€è§£ç                                                 â”‚  â”‚
â”‚  â”‚  â€¢ éŸ³è§†é¢‘åŒæ­¥                                                  â”‚  â”‚
â”‚  â”‚  â€¢ æ™ºèƒ½å¸§ä¸¢å¼ƒ                                                  â”‚  â”‚
â”‚  â”‚  â€¢ VideoState ç»“æ„ä½“ï¼ˆåŒ…å« skyPlayer æŒ‡é’ˆç”¨äºå›è°ƒï¼‰            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€ä¸‰å±‚è°ƒç”¨é“¾è·¯è¯´æ˜ã€‘
1. Kotlin â†” Nativeï¼šé€šè¿‡ JNI åŒå‘è°ƒç”¨ï¼ˆæ–¹æ³•è°ƒç”¨ + äº‹ä»¶å›è°ƒï¼‰
2. C++ â†” Cï¼šé€šè¿‡ ffplay.h å’Œ skymediaplayer_interface.h åŒå‘è°ƒç”¨
3. Native â†” Android å¹³å°ï¼šé€šè¿‡ EGL/OpenGL ES å’Œ OpenSL ES å¯¹æ¥ç³»ç»Ÿ
```

### ä¸‰å±‚è°ƒç”¨é“¾è·¯è®¾è®¡

SkyPlayer å®ç°äº†å®Œæ•´çš„ä¸‰å±‚åŒå‘è°ƒç”¨æœºåˆ¶ï¼š

#### ğŸ“± 1. C++ â†’ C è°ƒç”¨é“¾è·¯ï¼ˆskymediaplayer.cpp â†’ ffplay.cï¼‰

**è®¾è®¡æ€è·¯**ï¼šé€šè¿‡ `ffplay.h` æš´éœ² C æ¥å£ï¼ŒC++ é€šè¿‡ `extern "C"` è°ƒç”¨

```cpp
// skymediaplayer.cpp ä¸­è°ƒç”¨ ffplay.c çš„å‡½æ•°
extern "C" {
#include "ffplay.h"
}

void SkyPlayer::prepareAsync() {
    // è°ƒç”¨ ffplay.c ä¸­çš„å‡½æ•°æ‰“å¼€åª’ä½“æµ
    is = stream_open(data_source_, nullptr);
    if (is) {
        is->skyPlayer = this;  // å»ºç«‹ C â†’ C++ çš„å›è°ƒè¿æ¥
        setPlayerState(STATE_PREPARED);
    }
}

void SkyPlayer::start() {
    toggle_pause(is);  // æ§åˆ¶æ’­æ”¾/æš‚åœ
}

void SkyPlayer::seekTo(int64_t msec) {
    stream_seek(is, msec * 1000, 0, 0);  // å®šä½æ’­æ”¾ä½ç½®
}
```

**ffplay.h ä¸­çš„å…³é”®æ¥å£**ï¼š
```c
#ifdef __cplusplus
extern "C" {
#endif

typedef struct VideoState {
    void* skyPlayer;  // C â†’ C++ å›è°ƒæŒ‡é’ˆ
    // ... å…¶ä»–å­—æ®µ
} VideoState;

// ä¾› C++ è°ƒç”¨çš„ C æ¥å£
VideoState *stream_open(const char *filename, const AVInputFormat *iformat);
void stream_close(VideoState *is);
void toggle_pause(VideoState *is);
void stream_seek(VideoState *is, int64_t pos, int64_t rel, int by_bytes);
double get_current_position(VideoState *is);
int64_t get_media_duration(VideoState *is);

#ifdef __cplusplus
}
#endif
```

#### ğŸ”„ 2. C â†’ C++ è°ƒç”¨é“¾è·¯ï¼ˆffplay.c â†’ skymediaplayer.cppï¼‰

**è®¾è®¡æ€è·¯**ï¼šé€šè¿‡ `skymediaplayer_interface.h` å®šä¹‰ C æ¥å£ï¼Œffplay.c é€šè¿‡ `VideoState.skyPlayer` æŒ‡é’ˆå›è°ƒ

```c
// ffplay.c ä¸­å›è°ƒ C++ ä»£ç 
static void sky_video_image_display(VideoState *is) {
    Frame *vp = frame_queue_peek_last(&is->pictq);
    if (!vp->uploaded) {
        // è°ƒç”¨ C++ å±‚çš„è§†é¢‘æ˜¾ç¤ºæ¥å£
        if (!sky_display_image(is->skyPlayer, vp->frame)) {
            return;
        }
        vp->uploaded = 1;
    }
}

// éŸ³é¢‘æ§åˆ¶å›è°ƒ
sky_pause_audio(is->skyPlayer, is->paused);
sky_open_audio(is->skyPlayer, &wanted_spec, &spec);

// æ¶ˆæ¯å‘é€å›è°ƒ
sky_post_simple_message(is->skyPlayer, SKY_MSG_PREPARED);
sky_post_message_ii(is->skyPlayer, SKY_MSG_ERROR, err, 0);
```

**skymediaplayer_interface.h ä¸­çš„å…³é”®æ¥å£**ï¼š
```c
#ifdef __cplusplus
extern "C" {
#endif

// è§†é¢‘æ˜¾ç¤ºæ¥å£
bool sky_display_image(void *player, AVFrame *frame);

// éŸ³é¢‘æ§åˆ¶æ¥å£
bool sky_open_audio(void *player, SkyAudioSpec *desired, SkyAudioSpec *obtained);
void sky_pause_audio(void *player, bool pause);
void sky_flush_audio(void *player);

// æ¶ˆæ¯å‘é€æ¥å£
bool sky_post_message(void *player, int what, int arg1, int arg2, void *obj);
bool sky_post_simple_message(void *player, int what);
bool sky_post_message_ii(void *player, int what, int arg1, int arg2);

#ifdef __cplusplus
}
#endif
```

**skymediaplayer.cpp ä¸­çš„æ¥å£å®ç°**ï¼š
```cpp
bool sky_display_image(void *player, AVFrame *frame) {
    auto* skyPlayer = reinterpret_cast<SkyPlayer*>(player);
    return skyPlayer->getSkyVideoOutHandler().displayImage(frame);
}

bool sky_open_audio(void *player, SkyAudioSpec *desired, SkyAudioSpec *obtained) {
    auto* skyPlayer = reinterpret_cast<SkyPlayer*>(player);
    return skyPlayer->getSkyAudioOutHandler().openAudio(desired, obtained);
}
```

#### ğŸŒ‰ 3. C++ â†’ Kotlin è°ƒç”¨é“¾è·¯ï¼ˆskymediaplayer.cpp â†’ JNI â†’ Kotlinï¼‰

**å®Œæ•´è°ƒç”¨é“¾**ï¼š
```
skymediaplayer.cpp 
  â†’ postMediaEventToJava() 
  â†’ postEventToJava() (JNIå±‚)
  â†’ SkyMediaPlayer.postEventFromNative() (Kotliné™æ€æ–¹æ³•)
  â†’ handleEventFromNative()
  â†’ MediaEventHandler.handleMessage()
  â†’ ç›‘å¬å™¨å›è°ƒ
```

**Kotlin å±‚å£°æ˜ Native æ–¹æ³•**ï¼š
```kotlin
class SkyMediaPlayer : IMediaPlayer {
    private external fun _native_setup()
    private external fun _setDataSource(path: String)
    private external fun _prepareAsync()
    private external fun _start()
    private external fun _pause()
    private external fun _seekTo(msec: Long)
    private external fun _release()
}
```

**JNI å±‚æ–¹æ³•æ³¨å†Œ**ï¼š
```cpp
// skymediaplayer_jni.cpp
static JNINativeMethod methods[] = {
    {"_native_setup", "()V", (void*)sky_mediaPlayer_native_setup},
    {"_setDataSource", "(Ljava/lang/String;)V", (void*)sky_mediaPlayer_setDataSource},
    {"_prepareAsync", "()V", (void*)sky_mediaPlayer_prepareAsync},
    {"_start", "()V", (void*)sky_mediaPlayer_start},
    {"_pause", "()V", (void*)sky_mediaPlayer_pause},
    {"_seekTo", "(J)V", (void*)sky_mediaPlayer_seekTo},
    {"_release", "()V", (void*)sky_mediaPlayer_release}
};

extern "C" JNIEXPORT jint JNICALL JNI_OnLoad(JavaVM *vm, void *reserved) {
    // æ³¨å†Œ Native æ–¹æ³•
    env->RegisterNatives(clazz, methods, sizeof(methods) / sizeof(methods[0]));
    return JNI_VERSION_1_6;
}
```

**Native â†’ Kotlin äº‹ä»¶å›è°ƒ**ï¼š
```cpp
// skymediaplayer_jni.cpp
bool postEventToJava(SkyPlayer* player, int what, int arg1, int arg2, jobject obj) {
    JNIEnv* env = getJNIEnv();  // çº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼Œè‡ªåŠ¨ attach
    
    // ä»å¼±å¼•ç”¨è·å– Java å¯¹è±¡
    jweak weakRef = player->getWeakJavaPlayerPtr();
    jobject strongRef = env->NewLocalRef(weakRef);
    
    // è°ƒç”¨ Kotlin é™æ€æ–¹æ³•
    env->CallStaticVoidMethod(
        methodManager.getJavaClass(), 
        methodManager.getPostEventFromNative(),
        strongRef, what, arg1, arg2, obj
    );
    
    env->DeleteLocalRef(strongRef);
    return true;
}
```

**Kotlin å±‚æ¥æ”¶äº‹ä»¶**ï¼š
```kotlin
class SkyMediaPlayer {
    companion object {
        @Keep
        @JvmStatic
        private fun postEventFromNative(
            player: SkyMediaPlayer?,
            what: Int,
            arg1: Int,
            arg2: Int,
            obj: Any?
        ) {
            player?.handleEventFromNative(what, arg1, arg2, obj)
        }
    }
    
    private fun handleEventFromNative(what: Int, arg1: Int, arg2: Int, obj: Any?) {
        mEventHandler.sendMessage(what, arg1, arg2, obj)
    }
}
```

**ğŸ”’ çº¿ç¨‹å®‰å…¨ä¿éšœ**ï¼š
1. **TLSï¼ˆçº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼‰**ï¼šæ¯ä¸ªçº¿ç¨‹ç‹¬ç«‹çš„ JNIEnv ç¼“å­˜
2. **è‡ªåŠ¨ attach/detach**ï¼šçº¿ç¨‹ç”Ÿå‘½å‘¨æœŸè‡ªåŠ¨ç®¡ç†
3. **å¼±å…¨å±€å¼•ç”¨**ï¼šé˜²æ­¢ Java å¯¹è±¡å†…å­˜æ³„æ¼
4. **æ¶ˆæ¯é˜Ÿåˆ—**ï¼šå¼‚æ­¥äº‹ä»¶å¤„ç†ï¼Œé¿å…é˜»å¡

### FFmpeg ç‰ˆæœ¬å‡çº§ä¼˜åŠ¿

å¾—ç›Šäºæ¸…æ™°çš„è°ƒç”¨é“¾è·¯è®¾è®¡,C å’Œ C++ ä»£ç å®Œå…¨éš”ç¦»ã€‚SkyPlayer çš„ FFmpeg ç‰ˆæœ¬å‡çº§æˆæœ¬æä½ï¼Œéšæ—¶è·Ÿè¿› FFmpeg å®˜æ–¹æ›´æ–°:

**FFmpeg 6.1 â†’ 8.0 å‡çº§å®æˆ˜**ï¼š
- âœ… `ffplay.c` æ›¿æ¢æ–°ç‰ˆæœ¬æ–‡ä»¶ï¼Œè§£å†³éƒ¨åˆ†ç¼–è¯‘é—®é¢˜
- âœ… ä»…éœ€è°ƒæ•´ `ffplay.h` ä¸­å°‘é‡æ¥å£å£°æ˜
- âœ… `skymediaplayer_interface.h` ä¿æŒä¸å˜
- âœ… **å®é™…è€—æ—¶ï¼š< 1 å°æ—¶**

## æŠ€æœ¯ç»†èŠ‚

### ffplay è§£å°è£…ã€è§£ç æµç¨‹

ffplay çš„æ ¸å¿ƒæµç¨‹å¯ä»¥ç”¨ä»¥ä¸‹æ—¶åºå›¾è¡¨ç¤ºï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¯»å–çº¿ç¨‹ â”‚      â”‚ è§†é¢‘è§£ç   â”‚      â”‚ éŸ³é¢‘è§£ç   â”‚      â”‚ æ¸²æŸ“çº¿ç¨‹  â”‚
â”‚(read_   â”‚      â”‚ çº¿ç¨‹      â”‚      â”‚ çº¿ç¨‹      â”‚      â”‚          â”‚
â”‚thread)  â”‚      â”‚(video_   â”‚      â”‚(audio_   â”‚      â”‚          â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â”‚thread)   â”‚      â”‚thread)   â”‚      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚           â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜           â”‚
     â”‚                â”‚                  â”‚                 â”‚
     â”‚ 1. æ‰“å¼€æ–‡ä»¶    â”‚                  â”‚                 â”‚
     â”‚ avformat_open_input()             â”‚                 â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                â”‚                  â”‚                 â”‚
     â”‚ 2. æŸ¥æ‰¾æµä¿¡æ¯  â”‚                  â”‚                 â”‚
     â”‚ avformat_find_stream_info()       â”‚                 â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                â”‚                  â”‚                 â”‚
     â”‚ 3. è¯»å– Packet â”‚                  â”‚                 â”‚
     â”‚ av_read_frame()â”‚                  â”‚                 â”‚
     â”‚â”€â”€â”€â”€â”           â”‚                  â”‚                 â”‚
     â”‚    â”‚           â”‚                  â”‚                 â”‚
     â”‚<â”€â”€â”€â”˜           â”‚                  â”‚                 â”‚
     â”‚                â”‚                  â”‚                 â”‚
     â”‚ 4. åˆ†å‘åˆ°é˜Ÿåˆ—  â”‚                  â”‚                 â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ PacketQueue     â”‚                 â”‚
     â”‚                â”‚                  â”‚                 â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ PacketQueue   â”‚
     â”‚                â”‚                  â”‚                 â”‚
     â”‚                â”‚ 5. è§£ç           â”‚                 â”‚
     â”‚                â”‚ avcodec_send_packet()              â”‚
     â”‚                â”‚ avcodec_receive_frame()            â”‚
     â”‚                â”‚â”€â”€â”€â”€â”             â”‚                 â”‚
     â”‚                â”‚    â”‚             â”‚                 â”‚
     â”‚                â”‚<â”€â”€â”€â”˜             â”‚                 â”‚
     â”‚                â”‚                  â”‚                 â”‚
     â”‚                â”‚ 6. æ”¾å…¥å¸§é˜Ÿåˆ—    â”‚                 â”‚
     â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                â”‚                  â”‚                 â”‚
     â”‚                â”‚                  â”‚ 7. è§£ç          â”‚
     â”‚                â”‚                  â”‚ avcodec_send_packet()
     â”‚                â”‚                  â”‚ avcodec_receive_frame()
     â”‚                â”‚                  â”‚â”€â”€â”€â”€â”            â”‚
     â”‚                â”‚                  â”‚    â”‚            â”‚
     â”‚                â”‚                  â”‚<â”€â”€â”€â”˜            â”‚
     â”‚                â”‚                  â”‚                 â”‚
     â”‚                â”‚                  â”‚ 8. æ”¾å…¥å¸§é˜Ÿåˆ—   â”‚
     â”‚                â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                â”‚                  â”‚                 â”‚
     â”‚                â”‚                  â”‚                 â”‚ 9. éŸ³ç”»åŒæ­¥
     â”‚                â”‚                  â”‚                 â”‚    æ¸²æŸ“è¾“å‡º
     â”‚                â”‚                  â”‚                 â”‚â”€â”€â”€â”€â”
     â”‚                â”‚                  â”‚                 â”‚    â”‚
     â”‚                â”‚                  â”‚                 â”‚<â”€â”€â”€â”˜
```

**å…³é”®æ•°æ®ç»“æ„**ï¼š

1. **PacketQueue**ï¼šå­˜å‚¨æœªè§£ç çš„ AVPacket
2. **FrameQueue**ï¼šå­˜å‚¨å·²è§£ç çš„ AVFrame
3. **Clock**ï¼šéŸ³é¢‘æ—¶é’Ÿã€è§†é¢‘æ—¶é’Ÿã€å¤–éƒ¨æ—¶é’Ÿ

**æ ¸å¿ƒä»£ç ç‰‡æ®µ**ï¼š

```c
// ffplay.c - è§£ç çº¿ç¨‹ä¸»å¾ªç¯
static int decoder_decode_frame(Decoder *d, AVFrame *frame) {
    int ret = AVERROR(EAGAIN);
    
    for (;;) {
        // 1. å°è¯•æ¥æ”¶è§£ç åçš„å¸§
        ret = avcodec_receive_frame(d->avctx, frame);
        if (ret >= 0) {
            // è®¡ç®— PTS
            AVRational tb = (AVRational){1, frame->sample_rate};
            if (frame->pts != AV_NOPTS_VALUE)
                frame->pts = av_rescale_q(frame->pts, d->avctx->pkt_timebase, tb);
            return 1;
        }
        
        // 2. ä»é˜Ÿåˆ—è·å– Packet
        if (packet_queue_get(d->queue, d->pkt, 1, &d->pkt_serial) < 0)
            return -1;
            
        // 3. å‘é€ Packet åˆ°è§£ç å™¨
        ret = avcodec_send_packet(d->avctx, d->pkt);
        av_packet_unref(d->pkt);
    }
}
```

### OpenGL ES 2.0 ç”»é¢æ¸²æŸ“

#### ğŸš€ ä¸ºä»€ä¹ˆç”¨ OpenGL ESï¼Ÿ

| å¯¹æ¯”ç»´åº¦ | CPU æ¸²æŸ“ï¼ˆCanvasï¼‰ | OpenGL ES 2.0 |
|---------|-------------------|---------------|
| **æ€§èƒ½** | åŸºå‡† | **10-100x æ›´å¿«** |
| **åŠŸè€—** | é«˜ CPU å ç”¨ | **ä½åŠŸè€—** |
| **åˆ†è¾¨ç‡** | 1080P åƒåŠ› | **4K+ æµç•…** |
| **æ‰©å±•æ€§** | å—é™ | **æ»¤é•œã€ç‰¹æ•ˆéšæ„åŠ ** |
| **å…¼å®¹æ€§** | ç³»ç»Ÿä¾èµ– | **å¹¿æ³›æ”¯æŒ** |

#### æ¸²æŸ“æ¶æ„

SkyPlayer å®ç°äº† 5 ç§åƒç´ æ ¼å¼çš„ç‹¬ç«‹æ¸²æŸ“å™¨ï¼š

```cpp
// skyrenderer.cpp - æ¸²æŸ“å™¨å·¥å‚
std::unique_ptr<SkyEGL2RendererImp> createRenderImpFactory(AVPixelFormat format) {
    switch (format) {
        case AV_PIX_FMT_YUV420P:
            return std::make_unique<SkyEGL2RendererYUV420pImp>(format);
        case AV_PIX_FMT_NV12:
            return std::make_unique<SkyEGL2RendererNV12Imp>(format);
        case AV_PIX_FMT_NV21:
            return std::make_unique<SkyEGL2RendererNV21Imp>(format);
        case AV_PIX_FMT_RGBA:
            return std::make_unique<SkyEGL2RendererRGBAImp>(format);
        case AV_PIX_FMT_YUV422P:
            return std::make_unique<SkyEGL2RendererYUV422pImp>(format);
        default:
            return nullptr;
    }
}
```

#### ğŸ¨ YUV420P æ¸²æŸ“å®ç°

**æ¸²æŸ“ç®¡çº¿**ï¼š
```
AVFrame (YUV) â†’ ä¸Šä¼ çº¹ç† â†’ Shader è½¬æ¢ â†’ RGB è¾“å‡º
```

**æ ¸å¿ƒä»£ç **ï¼š

```glsl
// Fragment Shader - YUV â†’ RGB è½¬æ¢
void main() {
    vec3 yuv;
    yuv.x = texture2D(samplerY, texCoord).r;        // Y å¹³é¢
    yuv.y = texture2D(samplerU, texCoord).r - 0.5;  // U å¹³é¢
    yuv.z = texture2D(samplerV, texCoord).r - 0.5;  // V å¹³é¢
    
    vec3 rgb = colorMatrix * yuv;  // è‰²å½©ç©ºé—´è½¬æ¢
    gl_FragColor = vec4(rgb, 1.0);
}
```

```cpp
// çº¹ç†ä¸Šä¼ ï¼ˆ3 ä¸ªå¹³é¢ï¼‰
glTexImage2D(GL_TEXTURE_2D, 0, GL_LUMINANCE, 
             width, height, 0, GL_LUMINANCE, GL_UNSIGNED_BYTE, 
             avFrame->data[0]);  // Y
glTexImage2D(..., width/2, height/2, ..., avFrame->data[1]);  // U
glTexImage2D(..., width/2, height/2, ..., avFrame->data[2]);  // V
```

### OpenSL ES éŸ³é¢‘æ¸²æŸ“

#### âš¡ ä¸ºä»€ä¹ˆç”¨ OpenSL ESï¼Ÿ

| ç‰¹æ€§ | AudioTrack | OpenSL ES |
|-----|-----------|-----------|
| **å»¶è¿Ÿ** | > 100ms | **< 20ms** |
| **æ€§èƒ½** | ä¸­é—´å±‚å¼€é”€ | **ç›´æ¥ç¡¬ä»¶è®¿é—®** |
| **æ§åˆ¶** | å—é™ | **ç²¾ç¡®ç¼“å†²åŒºç®¡ç†** |
| **é€‚ç”¨åœºæ™¯** | æ™®é€šæ’­æ”¾ | **å®æ—¶éŸ³é¢‘ã€æ¸¸æˆ** |

#### ğŸ”§ åˆå§‹åŒ–æµç¨‹

```cpp
// 1. åˆ›å»ºå¼•æ“å’Œæ··éŸ³å™¨
slCreateEngine(&slObject_, ...);
(*slEngine_)->CreateOutputMix(...);

// 2. é…ç½®éŸ³é¢‘æ ¼å¼
format_pcm_.numChannels = channels;
format_pcm_.samplesPerSec = sampleRate * 1000;
format_pcm_.bitsPerSample = SL_PCMSAMPLEFORMAT_FIXED_16;

// 3. åˆ›å»ºæ’­æ”¾å™¨å¹¶æ³¨å†Œå›è°ƒ
(*slEngine_)->CreateAudioPlayer(...);
(*slBufferQueueItf_)->RegisterCallback(slBufferQueueItf_, callback, this);

// 4. å¯åŠ¨éŸ³é¢‘çº¿ç¨‹
audio_thread_ = std::thread([this]() { audioOutputThread(); });
```

#### ğŸ”„ ç¼“å†²åŒºç®¡ç†

```cpp
void audioOutputThread() {
    // è®¾ç½®å®æ—¶ä¼˜å…ˆçº§
    pthread_setschedparam(pthread_self(), SCHED_FIFO, &param);
    
    while (running) {
        if (hasEmptyBuffer()) {
            // ä» FFmpeg è·å–éŸ³é¢‘æ•°æ®
            spec_.callback(userdata, buffer, size);
            
            // å…¥é˜Ÿæ’­æ”¾
            (*slBufferQueueItf_)->Enqueue(slBufferQueueItf_, buffer, size);
        } else {
            // ç­‰å¾…ç¼“å†²åŒºç©ºé—²
            wait(10ms);
        }
    }
}
```

**å…³é”®ä¼˜åŒ–**ï¼š
- ğŸ¯ **å®æ—¶çº¿ç¨‹ä¼˜å…ˆçº§**ï¼šä¿è¯éŸ³é¢‘ä¸å¡é¡¿
- ğŸ”„ **å¤šç¼“å†²åŒºè®¾è®¡**ï¼šå¹³æ»‘æ’­æ”¾
- â±ï¸ **ç²¾ç¡®æ—¶é—´æ§åˆ¶**ï¼š< 20ms å»¶è¿Ÿ

### éŸ³ç”»åŒæ­¥ä¸ Seek å®ç°

#### ğŸ¬ éŸ³ç”»åŒæ­¥ç­–ç•¥

**æ ¸å¿ƒæ€æƒ³**ï¼šä»¥éŸ³é¢‘ä¸ºä¸»æ—¶é’Ÿï¼Œè§†é¢‘è·Ÿéš

```
éŸ³é¢‘æ—¶é’Ÿï¼ˆMasterï¼‰
    â†“
è®¡ç®—è§†é¢‘ä¸éŸ³é¢‘çš„æ—¶é—´å·®
    â†“
è§†é¢‘å¤ªå¿« â†’ å»¶è¿Ÿæ˜¾ç¤º
è§†é¢‘å¤ªæ…¢ â†’ ä¸¢å¸§
```

**æ ¸å¿ƒç®—æ³•**ï¼š

```c
double compute_target_delay(double delay, VideoState *is) {
    double master_clock = get_master_clock(is);  // éŸ³é¢‘æ—¶é’Ÿ
    double diff = get_clock(&is->vidclk) - master_clock;  // æ—¶é—´å·®
    
    if (diff <= -sync_threshold)
        delay = FFMAX(0, delay + diff);  // è§†é¢‘æ…¢ï¼Œå‡å°‘å»¶è¿Ÿ
    else if (diff >= sync_threshold)
        delay = delay + diff;  // è§†é¢‘å¿«ï¼Œå¢åŠ å»¶è¿Ÿ
    
    return delay;
}
```

#### â© Seek å®ç°

**æŒ‘æˆ˜**ï¼šå¤šçº¿ç¨‹åè°ƒ + çŠ¶æ€é‡ç½®

**è§£å†³æ–¹æ¡ˆ**ï¼š

```c
// 1. å‘èµ· Seek è¯·æ±‚
stream_seek(is, target_pos, 0, 0);

// 2. è¯»å–çº¿ç¨‹å¤„ç†
if (is->seek_req) {
    avformat_seek_file(is->ic, -1, INT64_MIN, is->seek_pos, INT64_MAX, 0);
    
    // æ¸…ç©ºæ‰€æœ‰é˜Ÿåˆ—
    packet_queue_flush(&is->videoq);
    packet_queue_flush(&is->audioq);
    
    // é€šçŸ¥è§£ç å™¨åˆ·æ–°
    packet_queue_put(&is->videoq, &flush_pkt);
    packet_queue_put(&is->audioq, &flush_pkt);
    
    is->seek_req = 0;
}
```

**å…³é”®æ­¥éª¤**ï¼š
1. âœ… æ‰§è¡Œ Seek
2. âœ… æ¸…ç©ºç¼“å†²åŒº
3. âœ… åˆ·æ–°è§£ç å™¨
4. âœ… é‡ç½®æ—¶é’Ÿ

### èµ„æºç®¡ç†ä¸é‡Šæ”¾

#### ğŸ—‚ï¸ èµ„æºç±»å‹

| èµ„æºç±»å‹ | å…·ä½“å†…å®¹ | é£é™© |
|---------|---------|------|
| **FFmpeg** | AVFormatContextã€AVCodecContextã€AVFrame | å†…å­˜æ³„æ¼ |
| **OpenGL** | çº¹ç†ã€ç€è‰²å™¨ã€EGL ä¸Šä¸‹æ–‡ | GPU èµ„æºæ³„æ¼ |
| **OpenSL ES** | å¼•æ“ã€æ’­æ”¾å™¨ã€ç¼“å†²åŒº | éŸ³é¢‘è®¾å¤‡å ç”¨ |
| **JNI** | å…¨å±€å¼•ç”¨ã€å±€éƒ¨å¼•ç”¨ | Java å¯¹è±¡æ³„æ¼ |
| **çº¿ç¨‹** | è¯»å–ã€è§£ç ã€éŸ³é¢‘çº¿ç¨‹ | çº¿ç¨‹æ³„æ¼ |

#### ğŸ”„ é‡Šæ”¾é¡ºåº

**å…³é”®åŸåˆ™**ï¼šå…ˆåœæ­¢ä½¿ç”¨è€…ï¼Œå†é‡Šæ”¾èµ„æº

```cpp
SkyPlayer::~SkyPlayer() {
    stop();                          // 1. åœæ­¢æ‰€æœ‰çº¿ç¨‹
    sky_ffplay_destroy(ffplayCtx_);  // 2. é‡Šæ”¾ FFmpeg
    videoOutHandler_.terminate();    // 3. é‡Šæ”¾æ¸²æŸ“å™¨
    audioOutHandler_.closeAudio();   // 4. é‡Šæ”¾éŸ³é¢‘
}
```

**OpenGL é‡Šæ”¾**ï¼š
```cpp
eglMakeCurrent(display_, EGL_NO_SURFACE, EGL_NO_SURFACE, EGL_NO_CONTEXT);
eglDestroyContext(display_, context_);
eglDestroySurface(display_, surface_);
eglTerminate(display_);
```

**OpenSL ES é‡Šæ”¾**ï¼š
```cpp
stop_thread_flag_.store(true);  // åœæ­¢çº¿ç¨‹
audio_thread_.join();           // ç­‰å¾…çº¿ç¨‹é€€å‡º
(*slPlayItf_)->SetPlayState(slPlayItf_, SL_PLAYSTATE_STOPPED);
(*slPlayerObject_)->Destroy(slPlayerObject_);  // é”€æ¯æ’­æ”¾å™¨
(*slObject_)->Destroy(slObject_);              // é”€æ¯å¼•æ“
```

**JNI é‡Šæ”¾**ï¼š
```cpp
env->DeleteWeakGlobalRef(weakRef);  // é‡Šæ”¾å¼±å¼•ç”¨
env->SetLongField(thiz, ptrField, 0);  // æ¸…é™¤æŒ‡é’ˆ
delete player;  // åˆ é™¤å¯¹è±¡
```

#### ğŸ›¡ï¸ RAII ä¿éšœ

```cpp
class SkyPlayer {
    std::unique_ptr<SkyEGL2Renderer> renderer_;  // è‡ªåŠ¨é‡Šæ”¾
    std::unique_ptr<SkyAudioOut> audioOut_;      // è‡ªåŠ¨é‡Šæ”¾
    
    ~SkyPlayer() {
        // æ™ºèƒ½æŒ‡é’ˆè‡ªåŠ¨è°ƒç”¨ææ„å‡½æ•°
    }
};
```

## æ€»ç»“ä¸å±•æœ›

### é¡¹ç›®æ€»ç»“

SkyPlayer åŸºäº FFmpeg 8.0 å®˜æ–¹ ffplay å®ç°äº†å®Œæ•´çš„ Android éŸ³è§†é¢‘æ’­æ”¾å™¨ï¼Œä¸»è¦å®Œæˆï¼š

- **æ’­æ”¾å¼•æ“**ï¼šä¿ç•™ ffplay æ ¸å¿ƒé€»è¾‘ï¼Œå®ç°è§£å°è£…ã€è§£ç ã€éŸ³è§†é¢‘åŒæ­¥
- **ç¡¬ä»¶åŠ é€Ÿ**ï¼šOpenGL ES 2.0 æ¸²æŸ“ï¼ˆ5 ç§åƒç´ æ ¼å¼ï¼‰+ OpenSL ES éŸ³é¢‘ï¼ˆ< 20ms å»¶è¿Ÿï¼‰
- **è·¨è¯­è¨€è°ƒç”¨**ï¼šKotlin â†” JNI â†” C++ â†” C å®Œæ•´é“¾è·¯
- **å·¥ç¨‹åŒ–**ï¼šçº¿ç¨‹å®‰å…¨ã€èµ„æºç®¡ç†ã€å¼‚æ­¥äº‹ä»¶å¤„ç†

è§£å†³äº† FFmpeg åœ¨ Android å¹³å°çš„é›†æˆã€æ€§èƒ½ä¼˜åŒ–å’Œç¨³å®šæ€§é—®é¢˜ã€‚

### å¼€å‘è·¯çº¿

#### âœ… å·²å®Œæˆ

- æ ¸å¿ƒæ’­æ”¾å¼•æ“ï¼ˆåŸºäº ffplayï¼‰
- 5 ç§åƒç´ æ ¼å¼ç¡¬ä»¶æ¸²æŸ“
- OpenSL ES ä½å»¶è¿ŸéŸ³é¢‘
- JNI çº¿ç¨‹å®‰å…¨æ¡†æ¶
- æœ¬åœ°æ–‡ä»¶æ’­æ”¾
- æ’­æ”¾æ§åˆ¶ï¼ˆæ’­æ”¾/æš‚åœ/Seekï¼‰

#### ğŸš§ è¿›è¡Œä¸­

- åœ¨çº¿è§†é¢‘æ’­æ”¾ï¼ˆHTTP/HTTPSï¼‰
- ç›´æ’­æµæ”¯æŒï¼ˆRTMPã€HLSï¼‰
- å­—å¹•æ¸²æŸ“
- æ’­æ”¾åˆ—è¡¨ç®¡ç†

#### ğŸ“‹ è®¡åˆ’ä¸­

- ç¡¬ä»¶è§£ç ï¼ˆMediaCodecï¼‰
- å€é€Ÿæ’­æ”¾
- æˆªå›¾/å½•åˆ¶
- æ›´å¤šæ ¼å¼æ”¯æŒ
- æ€§èƒ½ä¼˜åŒ–

### ğŸ™ è‡´è°¢

æ„Ÿè°¢ä»¥ä¸‹å¼€æºé¡¹ç›®ï¼š

- [FFmpeg](https://ffmpeg.org/) - å¤šåª’ä½“å¤„ç†åŸºçŸ³
- [ffplay](https://ffmpeg.org/ffplay.html) - æœ¬é¡¹ç›®æ ¸å¿ƒ
- [ijkplayer](https://github.com/bilibili/ijkplayer) - é‡è¦å‚è€ƒ
- [SDL](https://www.libsdl.org/) - ffplay åŸå§‹æ¸²æŸ“å±‚

---